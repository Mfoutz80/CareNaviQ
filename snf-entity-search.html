<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-N1SPXCJWH0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-N1SPXCJWH0');
</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CARE NAVIQ - Entity Search</title>
  <!-- Tailwind CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet"/>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <!-- D3.js for map -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");
    :root {
      --primary: #059669;
      --primary-light: #d9e6b8;
      --secondary: #059669;
      --secondary-light: #c7e0b8;
      --tertiary: #414141;
      --tertiary-light: #ffffff;
      --danger: #b33430;
      --danger-light: #f4d8d7;
      --dark: #2b2b2b;
      --gray: #059669;
      --light-gray: #f0f0f0;
      --white: #ffffff;
    }
    body {
      font-family: "Poppins", sans-serif;
      background-color: #f0f0f0;
    }
    .card {
      transition: all 0.3s ease;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.05);
    }
    .facility-card {
      background-color: var(--white);
      border-top: 3px solid var(--primary);
    }
    .search-input {
      border: 2px solid var(--light-gray);
      border-radius: 0.75rem;
      padding: 1rem 1.5rem;
      font-size: 1.125rem;
      width: 100%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
    }
    .search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
      outline: none;
    }
    .search-icon {
      position: absolute;
      right: 1.5rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      font-size: 1.25rem;
    }
    .results-container {
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }
    .result-item {
      background-color: var(--white);
      border-left: 4px solid transparent;
      transition: all 0.2s ease;
    }
    .result-item:hover {
      background-color: var(--primary-light);
      border-left-color: var(--primary);
    }
    .result-item:not(:last-child) {
      border-bottom: 1px solid var(--light-gray);
    }
    .entity-card {
      background-color: var(--white);
      border-radius: 1rem;
      box-shadow: 0 4px 10px -2px rgba(43, 43, 43, 0.05);
      border-top: 4px solid var(--primary);
    }
    .entity-header {
      background-color: var(--primary);
      color: var(--white);
      padding: 1.5rem;
      border-radius: 0.75rem 0.75rem 0 0;
    }
    .stat-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-weight: 500;
      font-size: 0.875rem;
      display: inline-flex;
      align-items: center;
    }
    .badge-primary {
      background-color: var(--primary-light);
      color: var(--primary);
    }
    .badge-secondary {
      background-color: var(--secondary-light);
      color: var(--secondary);
    }
    .badge-tertiary {
      background-color: var(--tertiary-light);
      color: var(--tertiary);
    }
    .metric-card {
      background: var(--white);
      border-radius: 0.75rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      padding: 1rem;
      height: 100%;
      border-top: 3px solid transparent;
      transition: all 0.2s ease;
    }
    .metric-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .metric-primary {
      border-top-color: var(--primary);
    }
    .metric-secondary {
      border-top-color: var(--secondary);
    }
    .metric-tertiary {
      border-top-color: var(--tertiary);
    }
    .metric-purple {
      border-top-color: #059669;
    }
    .progress-bar {
      height: 8px;
      border-radius: 4px;
      background-color: var(--light-gray);
      overflow: hidden;
      margin: 8px 0;
    }
    .progress-value {
      height: 100%;
      border-radius: 4px;
      transition: width 1s ease-in-out;
    }
    .progress-primary {
      background: linear-gradient(to right, #059669 var(--primary));
    }
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--gray);
    }
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--primary);
      opacity: 0.5;
    }
    .highlight {
      background-color: #f7f7e6;
      font-weight: 500;
    }
    .us-map {
      width: 100%;
      height: 300px;
      position: relative;
    }
    .state {
      fill: var(--light-gray);
      stroke: #fff;
      stroke-width: 0.5;
      transition: all 0.3s ease;
    }
    .state-active {
      fill: var(--primary);
    }
    .map-tooltip {
      position: absolute;
      background: white;
      padding: 5px 10px;
      border-radius: 3px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 12px;
      z-index: 10;
    }
    .chart-container {
      height: 220px;
      position: relative;
    }
    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid rgba(118, 150, 86, 0.2);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="sticky top-0 z-50">
    <header style="background-color: #ffffff" class="shadow-md">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <img src="logo.svg" alt="Care Naviq Logo" class="h-10 w-10 mr-2" onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIGZpbGw9IiM3Njk2NTYiIHJ4PSI4Ii8+PHBhdGggZD0iTTEwIDEwSDMwVjMwSDEwVjEwWiIgZmlsbD0id2hpdGUiLz48cGF0aCBkPSJNMTUgMjBIMjVNMTUgMTVIMjVNMTUgMjVIMjUiIHN0cm9rZT0iIzc2OTY1NiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48L3N2Zz4='">
            <div>
              <h1 class="text-2xl font-bold">
                <span style="color: #000000;">Care</span>
                <span style="color: #059669;">NaviQ</span>
              </h1>
            </div>
          </div>
          <nav class="flex items-center space-x-6">
            <a href="index.html" class="hover:text-primary transition flex items-center" style="color: #022119;">
              <i class="fas fa-tachometer-alt mr-2"></i> Home
            </a>
            <a href="#" class="hover:text-primary transition flex items-center" style="color: #022119;">
              <i class="fas fa-chart-bar mr-2"></i> Reports
            </a>
            <div class="relative">
              <button class="flex items-center hover:text-primary transition" style="color: #022119;">
                <i class="fas fa-user-circle mr-2"></i> Profile
                <i class="fas fa-chevron-down ml-2 text-xs"></i>
              </button>
            </div>
          </nav>
        </div>
      </div>
    </header>
  </div>

  <div class="container mx-auto px-4 py-8">
    <div class="mb-8">
      <h1 class="text-3xl font-bold" style="color: #2b2b2b;">Entity Search</h1>
      <p class="text-gray-600 mt-2">Find and explore skilled nursing facility ownership entities</p>
    </div>

    <div class="bg-white rounded-xl shadow-md p-8 mb-8">
      <div class="relative max-w-3xl mx-auto mb-6">
        <input type="text" id="entity-search" class="search-input" placeholder="Search by entity name..." autocomplete="off">
        <i class="fas fa-search search-icon"></i>
      </div>

      <div id="search-results" class="max-w-3xl mx-auto results-container hidden"></div>
      <div id="loading-indicator" class="hidden relative h-32">
        <div class="spinner"></div>
      </div>
      <div id="empty-state" class="max-w-3xl mx-auto empty-state">
        <i class="fas fa-search"></i>
        <h3 class="text-xl font-semibold mb-2">Start typing to search for entities</h3>
        <p class="text-gray-500">Search by entity name, state, or facility name</p>
      </div>
    </div>

    <div id="entity-details" class="hidden"></div>
  </div>

  <footer class="bg-white mt-12 py-8 border-t" style="border-color: #e6e6e6;">
    <div class="container mx-auto px-4">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="mb-4 md:mb-0">
          <div class="flex items-center">
            <img src="logo.svg" alt="Care Naviq Logo" class="h-8 w-8 mr-2" onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIGZpbGw9IiM3Njk2NTYiIHJ4PSI4Ii8+PHBhdGggZD0iTTEwIDEwSDMwVjMwSDEwVjEwWiIgZmlsbD0id2hpdGUiLz48cGF0aCBkPSJNMTUgMjBIMjVNMTUgMTVIMjVNMTUgMjVIMjUiIHN0cm9rZT0iIzc2OTY1NiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48L3N2Zz4='">
            <h1 class="text-xl font-bold">
              <span style="color: #000000;">Care</span>
              <span style="color: #059669;">NaviQ</span>
            </h1>
          </div>
        </div>
        <div class="text-sm text-center md:text-right" style="color: #020f0b;">
          © <span id="current-year"></span> CARE NAVIQ. All rights reserved.
        </div>
      </div>
    </div>
  </footer>

  <script>
    document.getElementById('current-year').textContent = new Date().getFullYear();

    let entityData = [];
    let searchTimeout;
    
    const searchInput = document.getElementById('entity-search');
    const searchResults = document.getElementById('search-results');
    const loadingIndicator = document.getElementById('loading-indicator');
    const emptyState = document.getElementById('empty-state');
    const entityDetails = document.getElementById('entity-details');

    const stateAbbreviations = {
      'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
      'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia',
      'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
      'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
      'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi', 'MO': 'Missouri',
      'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',
      'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
      'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
      'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',
      'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming',
      'DC': 'District of Columbia'
    };

    function showLoading() {
      loadingIndicator.classList.remove('hidden');
      searchResults.classList.add('hidden');
      emptyState.classList.add('hidden');
    }

    function hideLoading() {
      loadingIndicator.classList.add('hidden');
    }

    async function loadEntityData() {
    try {
        console.log('Attempting to load entity data...');
        const response = await fetch('https://raw.githubusercontent.com/Net-RVA/snf-data/refs/heads/main/enhanced_snf_owner_summary.json');
        if (!response.ok) throw new Error(`Network response was not ok: ${response.status}`);
        entityData = await response.json();
        console.log(`Loaded ${entityData.length} entities successfully`);
        checkURLParameters(); // Check URL params after data is loaded
    } catch (error) {
        console.error("Error loading data:", error);
        entityData = [];
        emptyState.innerHTML = '<p class="text-red-500">Error loading entity data. Please try again later.</p>';
        emptyState.classList.remove('hidden');
    }
}

function checkURLParameters() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('query');
        console.log('URL Query Parameter:', query);
        
        if (query) {
            const decodedQuery = decodeURIComponent(query);
            console.log('Decoded Query:', decodedQuery);
            searchInput.value = decodedQuery;
            performSearch(decodedQuery.toLowerCase().trim());
        } else {
            console.log('No query parameter found in URL');
        }
    } catch (error) {
        console.error('Error in checkURLParameters:', error);
    }
}

function calculateRebate(entity) {
  /*
    const P1 = 0.65, P2 = 0.7, P3 = 0.75, P4 = 0.8, P5 = 0.85;
    const F = entity.overview?.total_facility_count || 0;
    const B = F > 0 ? (entity.overview?.total_beds || 0) / F : 0;
    const A = entity.payer_mix?.medicare || 0;
    
    let P = F <= 29 ? P1 : F <= 59 ? P2 : F <= 89 ? P3 : F <= 119 ? P4 : P5;
    return (F * B * A / 100) * 1668.24 * P;
  */
  return "N/A";
}

    function createStateMap(states) {
      d3.select('#state-map').html('');
      const width = 700;
      const height = 400;
      
      const svg = d3.select('#state-map')
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .attr('viewBox', '0 0 950 600')
        .attr('preserveAspectRatio', 'xMidYMid meet');
      
      const tooltip = d3.select('body').append('div')
        .attr('class', 'map-tooltip')
        .style('opacity', 0);
      
      d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json').then(us => {
        const stateIds = {
          '01': 'AL', '02': 'AK', '04': 'AZ', '05': 'AR', '06': 'CA', '08': 'CO', '09': 'CT',
          '10': 'DE', '11': 'DC', '12': 'FL', '13': 'GA', '15': 'HI', '16': 'ID', '17': 'IL',
          '18': 'IN', '19': 'IA', '20': 'KS', '21': 'KY', '22': 'LA', '23': 'ME', '24': 'MD',
          '25': 'MA', '26': 'MI', '27': 'MN', '28': 'MS', '29': 'MO', '30': 'MT', '31': 'NE',
          '32': 'NV', '33': 'NH', '34': 'NJ', '35': 'NM', '36': 'NY', '37': 'NC', '38': 'ND',
          '39': 'OH', '40': 'OK', '41': 'OR', '42': 'PA', '44': 'RI', '45': 'SC', '46': 'SD',
          '47': 'TN', '48': 'TX', '49': 'UT', '50': 'VT', '51': 'VA', '53': 'WA', '54': 'WV',
          '55': 'WI', '56': 'WY'
        };
        
        const projection = d3.geoAlbersUsa()
          .fitSize([width, height], topojson.feature(us, us.objects.states));
        
        const path = d3.geoPath().projection(projection);
        
        svg.append('g')
          .selectAll('path')
          .data(topojson.feature(us, us.objects.states).features)
          .enter()
          .append('path')
          .attr('d', path)
          .attr('class', d => stateIds[d.id] && states.includes(stateIds[d.id]) ? 'state state-active' : 'state')
          .on('mouseover', function(event, d) {
            const stateCode = stateIds[d.id];
            if (stateCode) {
              tooltip.transition().duration(200).style('opacity', 0.9);
              tooltip.html(stateAbbreviations[stateCode])
                .style('left', (event.pageX + 5) + 'px')
                .style('top', (event.pageY - 28) + 'px');
            }
          })
          .on('mouseout', function() {
            tooltip.transition().duration(500).style('opacity', 0);
          });
      });
    }

    function renderPayerMixChart(payerMix) {
      const ctx = document.getElementById('payer-mix-chart').getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Medicare', 'Medicaid', 'Other'],
          datasets: [{
            data: [payerMix.medicare || 0, payerMix.medicaid || 0, payerMix.other || 0],
            backgroundColor: ['#e5ebdf', '#5a8b3f', '#babaad'],
            borderWidth: 0,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '50%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: { boxWidth: 122, padding: 25, usePointStyle: true, font: { family: "'Poppins', sans-serif" } }
            },
            tooltip: {
              callbacks: {
                label: context => `${context.label}: ${context.parsed.toFixed(1)}%`
              }
            }
          }
        }
      });
    }

    function createFacilitiesCards(facilities) {
    if (!facilities || facilities.length === 0) {
        return '<p class="text-sm text-center" style="color: #059669;">No facility data available</p>';
    }
    
    let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
    const sortedFacilities = [...facilities].sort((a, b) => a.name.localeCompare(b.name));
    
    sortedFacilities.forEach(facility => {
        const phoneFormatted = facility.phone ? 
            `(${facility.phone.slice(0,3)}) ${facility.phone.slice(3,6)}-${facility.phone.slice(6)}` : 
            'Not available';
        
        // Create URL from state, city, and facility name
        const facilityUrlName = facility.name.toLowerCase().replace(/\s+/g, '_');
        const stateAbbrev = facility.state.toLowerCase();
        const cityName = facility.city.toLowerCase().replace(/\s+/g, '_');
        const facilityUrl = `/snf-facilities/${stateAbbrev}_${cityName}_${facilityUrlName}.html`;
        
        // Create Google Maps search URL
        const mapSearch = encodeURIComponent(`${facility.address}, ${facility.city}, ${facility.state} ${facility.zip_code}`);
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${mapSearch}`;
        
        // Create phone URL (removing any non-digit characters for tel: link)
        const phoneUrl = facility.phone ? `tel:${facility.phone.replace(/\D/g, '')}` : '#';
        
        html += `
            <div class="facility-card card p-4 flex">
                <div class="w-10 flex-shrink-0 mr-4">
                    <i class="fas fa-building                     text-2xl" style="color: #059669;"></i>
                </div>
                <div class="flex-1">
                    <h4 class="text-lg font-semibold mb-2" style="color: #2b2b2b;">
                        <a href="${facilityUrl}" class="hover:text-primary transition" style="color: #2b2b2b;">
                            ${facility.name}
                        </a>
                    </h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-start">
                            <i class="fas fa-map-marker-alt mr-2 mt-1" style="color: #059669;"></i>
                            <div>
                                <div style="color: #022118;">
                                    <a href="${mapsUrl}" target="_blank" class="hover:text-primary transition" style="color: #022118;">
                                        ${facility.address}
                                    </a>
                                </div>
                                <div style="color: #022118;">${facility.city}, ${facility.state} ${facility.zip_code}</div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-phone mr-2" style="color: #059669;"></i>
                            <span style="color: #059669;">
                                ${facility.phone ? 
                                    `<a href="${phoneUrl}" class="hover:text-primary transition" style="color: #022118;">${phoneFormatted}</a>` : 
                                    phoneFormatted}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    return html;
}

function exportFacilitiesToExcel(entityName, facilities) {
    const headers = [
        'LTC_Rebate_FacilityKey', 'LTC_FacilityKey', 'FacilityNameLTC', 'Corpkey', 
        'PharmacyKey', 'PharmacyNPI', 'activeYN', 'Pharmacy', 'FacilityNamePharmacy', 
        'FacilityID', 'Address', 'City', 'FacilityState', 'Zip', 'Phone Number', 
        'Fax Number', 'ID_NUM'
    ];

    const data = facilities.map(facility => ({
        'LTC_Rebate_FacilityKey': '',
        'LTC_FacilityKey': '',
        'FacilityNameLTC': facility.name,
        'Corpkey': '',
        'PharmacyKey': '',
        'PharmacyNPI': '',
        'activeYN': '',
        'Pharmacy': '',
        'FacilityNamePharmacy': facility.name,
        'FacilityID': '',
        'Address': facility.address,
        'City': facility.city,
        'FacilityState': facility.state,
        'Zip': facility.zip_code,
        'Phone Number': facility.phone || '',
        'Fax Number': '',
        'ID_NUM': ''
    }));

    const ws = XLSX.utils.json_to_sheet(data, { header: headers });
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Facilities');
    
    const safeEntityName = entityName.replace(/[^a-zA-Z0-9]/g, '_');
    const filename = `${safeEntityName}_Facilities.xlsx`;
    
    XLSX.writeFile(wb, filename);
}

function displayEntityDetails(entity) {
    console.log('Displaying entity details for:', entity);
    if (!entity) {
        console.error('No entity provided');
        return;
    }
    
    const name = entity.entity_name;
    const facilities = entity.facilities || [];
    const overview = entity.overview || {};
    const qualityMetrics = entity.quality_metrics || {};
    const financialMetrics = entity.financial_metrics || {};
    const changes = entity.changes || {};
    const payerMix = entity.payer_mix || {};
    
    console.log('Facilities count:', facilities.length);
    
    const occupancyRate = overview.average_occupancy_rate || 0;
    const overallRating = qualityMetrics.overall_rating || 0;
    const ratingPercentage = (overallRating / 5) * 100;
    const rebate = calculateRebate(entity);
    const formattedRebate = rebate.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    
    const detailsHTML = `
        <div class="entity-card">
            <div class="entity-header">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">${name}</h2>
                        <p class="text-sm mt-2 opacity-90">
                            <i class="fas fa-map-marker-alt mr-1"></i> ${overview.unique_states?.length || 0} States of Operation
                        </p>
                    </div>
                    <div>
                        <span class="stat-badge badge-tertiary">
                            <i class="fas fa-star mr-1"></i> ${overallRating.toFixed(1)} Overall Rating
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <div class="mb-6 flex justify-end">
                    <button 
                        id="export-button"
                        class="bg-primary hover:bg-secondary text-black font-medium py-2 px-4 rounded-lg transition flex items-center"
                    >
                        <i class="fas fa-file-export mr-2"></i>Export Facilities to Excel
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="metric-card metric-primary">
                        <h3 class="text-sm uppercase font-semibold mb-2" style="color: #059669;">
                            <i class="fas fa-building mr-2" style="color: #022118;"></i>Facilities
                        </h3>
                        <p class="text-2xl font-bold" style="color: #2b2b2b;">${overview.total_facility_count || 0}</p>
                        <p class="text-xs mt-1" style="color: #059669;">
                            YoY Change: <span style="color: ${changes.facility_count_change > 0 ? '#5a8b3f' : changes.facility_count_change < 0 ? '#b33430' : '#059669'};">
                                ${changes.facility_count_change > 0 ? '+' : ''}${changes.facility_count_change || 0}
                            </span>
                        </p>
                    </div>
                    
                    <div class="metric-card metric-secondary">
                        <h3 class="text-sm uppercase font-semibold mb-2" style="color: #059669;">
                            <i class="fas fa-bed mr-2" style="color: #022118;"></i>Total Beds
                        </h3>
                        <p class="text-2xl font-bold" style="color: #2b2b2b;">${(overview.total_beds || 0).toLocaleString()}</p>
                        <p class="text-xs mt-1" style="color: #059669;">
                            YoY Change: <span style="color: ${changes.beds_change > 0 ? '#5a8b3f' : changes.beds_change < 0 ? '#b33430' : '#059669'};">
                                ${changes.beds_change > 0 ? '+' : ''}${changes.beds_change || 0}
                            </span>
                        </p>
                    </div>
                    
                    <div class="metric-card metric-tertiary">
                        <h3 class="text-sm uppercase font-semibold mb-2" style="color: #059669;">
                            <i class="fas fa-percentage mr-2" style="color: #022118;"></i>Occupancy
                        </h3>
                        <p class="text-2xl font-bold" style="color: #2b2b2b;">${occupancyRate.toFixed(1)}%</p>
                        <div class="progress-bar mt-2">
                            <div class="progress-value progress-primary" style="width: ${occupancyRate}%;"></div>
                        </div>
                    </div>
                    
                    <div class="metric-card metric-purple">
                        <h3 class="text-sm uppercase font-semibold mb-2" style="color: #059669;">
                            <i class="fas fa-calculator mr-2" style="color: #022118;"></i>Annual Rebate
                        </h3>
                        <p class="text-2xl font-bold" style="color: #2b2b2b;">$${formattedRebate}</p>
                        <p class="text-xs mt-1" style="color: #059669;">
                            Based on Medicare: ${payerMix.medicare?.toFixed(1) || 0}%
                        </p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <h medulla3 class="text-sm font-semibold mb-3" style="color: #022118;">
                            <i class="fas fa-map-marked-alt mr-2"></i>Geographic Presence
                        </h3>
                        <div class="us-map" id="state-map"></div>
                        <div class="text-sm mt-2 text-center" style="color: #059669;">
                            ${overview.unique_states?.length || 0} states with ${overview.total_facility_count || 0} facilities
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <h3 class="text-sm font-semibold mb-3" style="color: #022118;">
                            <i class="fas fa-hand-holding-usd mr-2"></i>Payer Mix
                        </h3>
                        <div class="chart-container">
                            <canvas id="payer-mix-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <h3 class="text-sm font-semibold mb-3" style="color: #022118;">
                            <i class="fas fa-chart-line mr-2"></i>Quality Metrics
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm" style="color: #059669;">Overall Rating</span>
                                    <span class="text-sm font-medium" style="color: #2b2b2b;">${qualityMetrics.overall_rating?.toFixed(1) || 'N/A'}</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-value progress-primary" style="width: ${ratingPercentage}%;"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm" style="color: #059669;">Health Inspection</span>
                                    <span class="text-sm font-medium" style="color: #2b2b2b;">${qualityMetrics.health_inspection_rating?.toFixed(1) || 'N/A'}</span>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm" style="color: #059669;">Staffing</span>
                                    <span class="text-sm font-medium" style="color: #2b2b2b;">${qualityMetrics.staffing_rating?.toFixed(1) || 'N/A'}</span>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm" style="color: #059669;">QM Rating</span>
                                    <span class="text-sm font-medium" style="color: #2b2b2b;">${qualityMetrics.qm_rating?.toFixed(1) || 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <h3 class="text-sm font-semibold mb-3" style="color: #022118;">
                            <i class="fas fa-dollar-sign mr-2"></i>Financial Metrics
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm" style="color: #059669;">Avg Cost/Day</span>
                                <span class="text-sm font-medium" style="color: #2b2b2b;">$${financialMetrics.avg_cost_per_day?.toFixed(2) || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm" style="color: #059669;">Avg Cost/Bed</span>
                                <span class="text-sm font-medium" style="color: #2b2b2b;">$${financialMetrics.avg_cost_per_bed?.toFixed(2) || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm" style="color: #059669;">Labor Cost %</span>
                                <span class="text-sm font-medium" style="color: #2b2b2b;">${financialMetrics.labor_cost_percentage?.toFixed(1) || 'N/A'}%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm" style="color: #059669;">Profit Margin</span>
                                <span class="text-sm font-medium" style="color: #2b2b2b;">${financialMetrics.profit_margin?.toFixed(1) || 'N/A'}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <h3 class="text-sm font-semibold mb-3" style="color: #022118;">
                            <i class="fas fa-chart-line mr-2"></i>Year-over-Year Changes
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm" style="color: #059669;">Facilities</span>
                                <span class="text-sm font-medium" style="color: ${changes.facility_count_change > 0 ? '#5a8b3f' : changes.facility_count_change < 0 ? '#b33430' : '#059669'};">
                                    ${changes.facility_count_change > 0 ? '+' : ''}${changes.facility_count_change || 0}
                                </span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm" style="color: #059669;">Beds</span>
                                <span class="text-sm font-medium" style="color: ${changes.beds_change > 0 ? '#5a8b3f' : changes.beds_change < 0 ? '#b33430' : '#059669'};">
                                    ${changes.beds_change > 0 ? '+' : ''}${changes.beds_change || 0}
                                </span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm" style="color: #059669;">Occupancy</span>
                                <span class="text-sm font-medium" style="color: ${changes.occupancy_rate_change > 0 ? '#5a8b3f' : changes.occupancy_rate_change < 0 ? '#b33430' : '#059669'};">
                                    ${changes.occupancy_rate_change > 0 ? '+' : ''}${changes.occupancy_rate_change?.toFixed(1) || 0}%
                                </span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm" style="color: #059669;">Rating</span>
                                <span class="text-sm font-medium" style="color: ${changes.overall_rating_change > 0 ? '#5a8b3f' : changes.overall_rating_change < 0 ? '#b33430' : '#059669'};">
                                    ${changes.overall_rating_change > 0 ? '+' : ''}${changes.overall_rating_change?.toFixed(1) || 0}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold" style="color: #022118;">
                            <i class="fas fa-building mr-2"></i>All Facilities (${facilities.length})
                        </h3>
                    </div>
                    ${createFacilitiesCards(facilities)}
                </div>
            </div>
        </div>
    `;
    
    entityDetails.innerHTML = detailsHTML;
    entityDetails.classList.remove('hidden');
    emptyState.classList.add('hidden');
    
    const exportButton = document.getElementById('export-button');
    if (exportButton) {
        console.log('Export button found in DOM');
        exportButton.addEventListener('click', function() {
            console.log('Export button clicked');
            exportFacilitiesToExcel(name, facilities);
        });
    } else {
        console.error('Export button not found in DOM');
    }
    
    entityDetails.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    setTimeout(() => {
        createStateMap(overview.unique_states || []);
        renderPayerMixChart(payerMix);
    }, 100);
}

function performSearch(query) {
    try {
        console.log('Performing search for:', query);
        showLoading();
        
        const matches = entityData.filter(entity => {
            const entityName = entity.entity_name.toLowerCase();
            const matchesName = entityName.includes(query);
            const matchesState = entity.overview?.unique_states?.some(state => state.toLowerCase().includes(query));
            const matchesFacility = entity.facilities?.some(f => 
                f.name.toLowerCase().includes(query) || 
                f.city.toLowerCase().includes(query) ||
                f.state.toLowerCase().includes(query));
            return matchesName || matchesState || matchesFacility;
        });
        
        console.log('Total matches found:', matches.length);
        console.log('Matched entity names:', matches.map(e => e.entity_name));
        
        hideLoading();
        
        if (matches.length > 0) {
            const exactMatch = matches.find(entity => {
                const isExact = entity.entity_name.toLowerCase() === query.toLowerCase();
                console.log(`Checking exact match: "${entity.entity_name.toLowerCase()}" === "${query.toLowerCase()}"? ${isExact}`);
                return isExact;
            });
            
            if (exactMatch) {
                console.log('Exact match found:', exactMatch.entity_name);
                displayEntityDetails(exactMatch);
                searchResults.classList.add('hidden');
                return;
            } else {
                console.log('No exact match found, showing partial matches');
            }
            
            const resultsToShow = matches.slice(0, 5);
            searchResults.innerHTML = '';
            
            resultsToShow.forEach(entity => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item p-4 cursor-pointer';
                const highlightedName = entity.entity_name.replace(new RegExp(query, 'gi'), match => `<span class="highlight">${match}</span>`);
                
                resultItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-medium text-lg" style="color: #2b2b2b;">${highlightedName}</div>
                            <div class="text-sm" style="color: #059669;">
                                <span class="mr-4">${entity.overview?.total_facility_count || 0} Facilities</span>
                                <span class="mr-4">${(entity.overview?.total_beds || 0).toLocaleString()} Beds</span>
                                <span>${entity.overview?.unique_states?.length || 0} States</span>
                            </div>
                        </div>
                        <div>
                            <span class="stat-badge badge-primary text-xs">${entity.quality_metrics?.overall_rating?.toFixed(1) || "N/A"} ★</span>
                        </div>
                    </div>
                `;
                
                resultItem.addEventListener('click', () => {
                    displayEntityDetails(entity);
                    searchInput.value = entity.entity_name;
                    searchResults.classList.add('hidden');
                });
                
                searchResults.appendChild(resultItem);
            });
            
            searchResults.classList.remove('hidden');
            emptyState.classList.add('hidden');
        } else {
            console.log('No matches found for query:', query);
            searchResults.innerHTML = `<div class="p-4 text-center" style="color: #059669;">No entities found matching "${query}"</div>`;
            searchResults.classList.remove('hidden');
            emptyState.classList.add('hidden');
        }
    } catch (error) {
        console.error('Error in performSearch:', error);
        hideLoading();
        searchResults.innerHTML = `<div class="p-4 text-center" style="color: #059669;">An error occurred while searching: ${error.message}</div>`;
        searchResults.classList.remove('hidden');
        emptyState.classList.add('hidden');
    }
}

searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    if (query.length < 2) {
        searchResults.innerHTML = '';
        searchResults.classList.add('hidden');
        emptyState.classList.remove('hidden');
        entityDetails.classList.add('hidden');
        return;
    }
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => performSearch(query), 300);
});

document.addEventListener('click', function(event) {
    if (!searchInput.contains(event.target) && !searchResults.contains(event.target)) {
        searchResults.classList.add('hidden');
    }
});

document.addEventListener('DOMContentLoaded', loadEntityData);
</script>
</body>
</html>